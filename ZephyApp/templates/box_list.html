{% extends "base.html" %}

{% block title %}Disponibilidad de Boxes{% endblock %}

{% block content %}
<!-- Filtros -->
<div class="mb-4 d-flex justify-content-center gap-3">
  <form method="get" action="" class="d-flex align-items-end gap-3">
    <!-- Filtro por estado -->
    <div class="d-flex flex-column align-items-center">
      <div class="p-2 mb-2 rounded" style="background-color: #3E6CD3; color: white; font-weight: bold;">
        Filtrar por estado
      </div>
      <select id="estado" name="estado" class="form-select">
        <option value="">Todos los estados</option>
        <option value="1" {% if request.GET.estado == "1" %}selected{% endif %}>Disponible</option>
        <option value="2" {% if request.GET.estado == "2" %}selected{% endif %}>Ocupado</option>
        <option value="3" {% if request.GET.estado == "3" %}selected{% endif %}>No disponible</option>
      </select>
    </div>
    <!-- Filtro por pasillo -->
    <!-- Filtro por pasillo -->
    <div class="d-flex flex-column align-items-center">
      <div class="p-2 mb-2 rounded" style="background-color: #3E6CD3; color: white; font-weight: bold;">
        Filtrar por pasillo
      </div>
      <select id="pasillo" name="pasillo" class="form-select">
        <option value="">Todos los pasillos</option>
        {% for pasillo in todos_los_pasillos %}
          <option value="{{ pasillo }}" {% if request.GET.pasillo == pasillo %}selected{% endif %}>{{ pasillo }}</option>
        {% endfor %}
      </select>
    </div>
        <!-- Botón Filtrar -->
    <div>
      <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>
  </form>
</div>

<!-- Leyenda -->
<div class="mb-4 d-flex justify-content-center gap-3">
  <span class="badge bg-success">Disponible</span>
  <span class="badge bg-danger">Ocupado</span>
  <span class="badge bg-warning text-dark">No Disponible</span>
</div>

<!-- Hora en vivo -->
<div class="mb-4 text-center">
  <strong>Hora actual:</strong> <span id="live-clock"></span>
</div>

<style>
  .box-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
  }

  .pasillo-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border: 2px solid #ccc;
    border-radius: 10px;
    width: 250px; 

  .pasillo-separator {
    width: 100%;
    text-align: center;
    font-weight: bold;
    color: #555;
    border-bottom: 1px solid #ccc;
    padding-bottom: 10px;
    margin-bottom: 10px;
  }
  .box-card div {
    font-size: 10px; /* Ajusta aún más el tamaño de las letras internas */
  }

  .box-card {
    width: 80px; /* Mantén el tamaño del box */
    height: 80px; /* Mantén la altura del box */
    border-radius: 10px;
    display: flex;
    flex-direction: column; /* Apila los elementos verticalmente */
    justify-content: center;
    align-items: center;
    font-weight: bold;
    text-align: center;
    color: white;
    text-decoration: none;
    gap: 5px; /* Espaciado entre los elementos internos */
    padding: 5px; /* Espaciado interno */
    font-size: 12px; /* Reduce el tamaño de la fuente */
    }

  .bg-warning.text-dark {
    color: #212529 !important;
  }

</style>

<div class="box-grid">
  {% for pasillo, boxes_grupo in boxes_por_pasillo.items %}
    <div class="pasillo-container">
      <div class="pasillo-separator">{{ pasillo }}</div>
      <div class="box-grid">
        {% for box in boxes_grupo %}
        <a href="{% if box.box.idbox %}{% url 'cambiar_estado_box' box.box.idbox %}{% else %}#{% endif %}" 
   id="box-{{ box.box.idbox }}" 
   class="box-card
   {% if box.box.estadobox_idestadobox.nombre == 'Disponible' %}
       bg-success
   {% elif box.box.estadobox_idestadobox.nombre == 'Ocupado' %}
       bg-danger
   {% elif box.box.estadobox_idestadobox.nombre == 'No disponible' %}
       bg-warning text-dark
   {% else %}
       bg-secondary
   {% endif %}">
   <div><strong>Box {{ box.box.numerobox }}</strong></div>
   <div><strong>AM:</strong> {{ box.porcentaje_am }}%</div>
   <div><strong>PM:</strong> {{ box.porcentaje_pm }}%</div>
</a>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>


<script>
const socket = new WebSocket('ws://' + window.location.host + '/ws/boxes/');

socket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    console.log('Mensaje recibido:', data);

    const boxElement = document.getElementById('box-' + data.box_id);
    if (boxElement) {
        boxElement.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-dark', 'bg-secondary');

        boxElement.classList.add(data.new_status_class);
        showToast(`Hubo una actualización en el box ${data.box_id}`);
        if (data.new_status_class === 'bg-warning') {
            boxElement.classList.add('text-dark');
        }
    }
};

socket.onopen = function() {
    console.log('WebSocket conectado');
};

socket.onclose = function() {
    console.log('WebSocket desconectado');
};
</script>
<script>
  function updateClock() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const timeString = `${hours}:${minutes}:${seconds}`;
    document.getElementById('live-clock').textContent = timeString;
  }

  setInterval(updateClock, 1000); 
  window.onload = updateClock;
</script>


{% endblock %}