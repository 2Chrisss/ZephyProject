{% extends "base.html" %}

{% block title %}Disponibilidad de Boxes{% endblock %}

{% block content %}
<div class="mb-4 d-flex justify-content-between align-items-center flex-wrap">

  <form method="get" action="" class="d-flex align-items-end gap-3">
    <div class="mx-auto d-flex align-items-end gap-3 flex-wrap">
      <div class="d-flex flex-column align-items-center">
        <div class="p-2 mb-2 rounded" style="background-color: #3E6CD3; color: white; font-weight: bold;">
          Filtrar por estado
        </div>
        <select id="estado" name="estado" class="form-select">
          <option value="">Todos los estados</option>
          <option value="1" {% if request.GET.estado == "1" %}selected{% endif %}>Disponible</option>
          <option value="2" {% if request.GET.estado == "2" %}selected{% endif %}>Ocupado</option>
          <option value="3" {% if request.GET.estado == "3" %}selected{% endif %}>No disponible</option>
        </select>
      </div>

      <div class="d-flex flex-column align-items-center">
        <div class="p-2 mb-2 rounded" style="background-color: #3E6CD3; color: white; font-weight: bold;">
          Filtrar por pasillo
        </div>
        <select id="pasillo" name="pasillo" class="form-select">
          <option value="">Todos los pasillos</option>
          {% for pasillo in todos_los_pasillos %}
            <option value="{{ pasillo }}" {% if request.GET.pasillo == pasillo %}selected{% endif %}>{{ pasillo }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="d-flex flex-column align-items-center">
        <div class="p-2 mb-2 rounded" style="background-color: #3E6CD3; color: white; font-weight: bold;">
          Filtrar por fecha
        </div>
        <input type="date" id="fecha" name="fecha" class="form-control"
               value="{{ request.GET.fecha|default_if_none:'' }}">
      </div>
      
      <div class="d-flex flex-column align-items-center">
        <div class="p-2 mb-2 rounded" style="background-color: #3E6CD3; color: white; font-weight: bold;">
          Filtrar por horario
        </div>
        <select id="horario" name="horario" class="form-control">
          <option value="" {% if horario_filtro == '' %}selected{% endif %}>Todos</option>
          <option value="AM" {% if horario_filtro == 'AM' %}selected{% endif %}>AM</option>
          <option value="PM" {% if horario_filtro == 'PM' %}selected{% endif %}>PM</option>
        </select>
      </div>
      <div class="d-flex justify-content-center mt-3">
        <button type="submit" class="btn btn-primary w-100 w-sm-auto">Filtrar</button>
      </div>
    </div>
  </form>
  <div class="d-flex flex-column align-items-center mt-3 mt-lg-0">
    <div class="mb-2 d-flex gap-2 flex-wrap justify-content-center">
      <span class="badge bg-success">Disponible</span>
      <span class="badge bg-danger">Ocupado</span>
      <span class="badge bg-warning text-dark">No Disponible</span>
    </div>
  
    <div>
      <strong>Hora actual:</strong> <span id="live-clock"></span>
    </div>
  </div>
</div>

<style>
  .box-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
  }

  .pasillo-container {
    display: flex;
    flex-direction: column;
    flex: 1 1 250px;
    min-width: 200px;
    max-width: 400px;
    border: 2px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    box-sizing: border-box;
  }

  .pasillo-separator {
    width: 100%;
    text-align: center;
    font-weight: bold;
    color: #555;
    border-bottom: 1px solid #ccc;
    padding-bottom: 10px;
    margin-bottom: 10px;
  }

  .inner-box-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    width: 100%;
    justify-content: center;
  }

  .box-card {
    flex: 1 1 calc(45% - 10px);
    height: 80px;
    max-width: 100px;
    min-width: 60px;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    text-align: center;
    color: white;
    text-decoration: none;
    gap: 5px;
    padding: 5px;
    font-size: 12px;
  }

  .box-card div {
    font-size: 10px;
  }

  .bg-warning.text-dark {
    color: #212529 !important;
  }

  @media (max-width: 768px) {
    .pasillo-container {
      flex: 1 1 100%;
      max-width: 100%;
    }
    .box-card {
      flex: 1 1 calc(30% - 10px);
    }
  }

  @media (max-width: 480px) {
    .box-card {
      flex: 1 1 calc(45% - 10px);
      max-width: 80px;
    }
  }
</style>
<div class="box-grid">
  {% for pasillo, boxes_grupo in boxes_por_pasillo.items %}
    <div class="pasillo-container">
      <div class="pasillo-separator">{{ pasillo }}</div>
      <div class="inner-box-grid">
        {% for box in boxes_grupo %}
          <a href="{% if box.box.idbox %}{% url 'cambiar_estado_box' box.box.idbox %}{% else %}#{% endif %}" 
            id="box-{{ box.box.idbox }}" 
            class="box-card
              {% if box.box.estadobox_idestadobox.nombre == 'Disponible' %}
                  bg-success
              {% elif box.box.estadobox_idestadobox.nombre == 'Ocupado' %}
                  bg-danger
              {% elif box.box.estadobox_idestadobox.nombre == 'No disponible' %}
                  bg-warning text-dark
              {% else %}
                  bg-secondary
              {% endif %}">
            <div><strong>Box {{ box.box.numerobox }}</strong></div>
            <div><strong>AM:</strong> {{ box.porcentaje_am }}%</div>
            <div><strong>PM:</strong> {{ box.porcentaje_pm }}%</div>
          </a>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<script>
const socket = new WebSocket('ws://' + window.location.host + '/ws/boxes/');

socket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    const boxElement = document.getElementById('box-' + data.box_id);
    if (boxElement) {
        boxElement.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-dark', 'bg-secondary');
        boxElement.classList.add(data.new_status_class);
        showToast(`Hubo una actualizaci√≥n en el box ${data.box_id}`);
        if (data.new_status_class === 'bg-warning') {
            boxElement.classList.add('text-dark');
        }
    }
};

socket.onopen = function() {
    console.log('WebSocket conectado');
};

socket.onclose = function() {
    console.log('WebSocket desconectado');
};
</script>

<script>
function updateClock() {
  const now = new Date();
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  const timeString = `${hours}:${minutes}:${seconds}`;
  document.getElementById('live-clock').textContent = timeString;
}
setInterval(updateClock, 1000);
window.onload = updateClock;
</script>

{% endblock %}
